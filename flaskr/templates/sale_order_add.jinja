<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link href="https://unpkg.com/nes.css@latest/css/nes.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{url_for('static', filename='styles.css')}}" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <title>Purchase Order Detail</title>
</head>

<body>
    <div style="margin: 10PX;">
        <button class="nes-btn is-primary" id="add-btn">Add</button>
        <button class="nes-btn is-primary" id="send-btn">Send</button>
        <div style="display: flex; margin:10px; flex-direction:column">
            <label for="member-id">Member</label>
            <select class="nes-select" id="member-id">
                {%for member in members%}
                <option value="{{member.id}}">{{member.name}}</option>
                {%endfor%}
            </select>
            <label for="staff-id">Staff</label>
            <select class="nes-select" id="staff-id">
                {%for staff in staffs%}
                <option value="{{staff.staff_id}}">{{staff.name}}</option>
                {%endfor%}
            </select>

        </div>
        <div class="nes-table responsive">
            <table class="nes-table is-bordered" id="item-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Quantity</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="item-list">
                    {%for item in items%}
                    <tr style="text-align: center;">
                    </tr>
                    {%endfor%}
                </tbody>
            </table>
        </div>
    </div>
    <dialog class="nes-dialog" id="item_add">
        <button class="nes-btn is-primary" id="reset-btn">rest</button>
        <form method="dialog">
            <p class="title">Add Item</p>
            <label for="item-name">Name</label>
            <input type="text" class="nes-input" id="item-name">
            <label for="item-type">Type</label>
            <input type="text" class="nes-input" id="item-type">
            <label for="item-quantity">Quantity</label>
            <input type="text" class="nes-input" id="item-quantity">
            <menu class="dialog-menu">
                <button class="nes-btn" id="ok-btn">OK</button>
                <button class="nes-btn is-primary" id="cancel-btn">Cancel</button>
            </menu>
        </form>
    </dialog>
</body>
<script>
    $(document).ready(function () {
        const reset = function () {
            $("#item-name").val("");
            $("#item-type").val("");
            $("#item-quantity").val("");
        }
        $("#add-btn").click(function () {
            $("#item_add").show();
        });
        $("#cancel-btn").click(function () {
            $("#item_add").hide();
        });
        $("#reset-btn").click(function () {
            reset();
        });
        $("#ok-btn").click(function () {
            $("#item_add").hide();
            const item_name = $("#item-name").val();
            const item_type = $("#item-type").val();
            const item_quantity = $("#item-quantity").val();
            if (item_name == "" || item_type == "" || item_quantity == "") {
                alert("Please fill all the blanks");
                return;
            }
            const item = "<tr style='text-align: center;'><td>" + item_name + "</td><td>" + item_type + "</td><td>" + item_quantity + "</td><td><button class='nes-btn removeRowBtn'>Delete</button></td></tr>";
            $("#item-list").append(item);
            reset();
        })
        $('#item-table').on('click', '.removeRowBtn', function () {
            // Find the closest table row and remove it
            $(this).closest('tr').remove();
        });

        $("#send-btn").click(function(){
            const data = {
                member_id: $("#member-id").val(),
                staff_id: $("#staff-id").val(),
                item_list: []
            }
            $("#item-list tr").each(function(){
                const item = {
                    name: $(this).find("td").eq(0).html(),
                    type: $(this).find("td").eq(1).html(),
                    quantity: $(this).find("td").eq(2).html()
                }
                data.item_list.push(item);
            })
            const response = fetch("/sale_order", {
                method: "POST",
                body: JSON.stringify(data),
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(function(response){
                if(response.status == 200){
                    alert(response.body);
                    window.location.href = "/myErp/sale_order";
                }else{
                    alert("fail");
                }
            })
        })

    });
</script>

</html>